#!/bin/bash
set -e

WPDEV_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATE_DIR="$WPDEV_DIR/template"
SITES_DIR="$WPDEV_DIR/sites"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_success() { echo -e "${GREEN}$1${NC}"; }
print_error() { echo -e "${RED}Error: $1${NC}" >&2; }
print_info() { echo -e "${BLUE}$1${NC}"; }
print_warning() { echo -e "${YELLOW}$1${NC}"; }

usage() {
    echo "WordPress Development Environment CLI"
    echo ""
    echo "Usage: wpdev <command> [options]"
    echo ""
    echo "Commands:"
    echo "  new <name> [port]    Create a new WordPress environment (default port: 8080)"
    echo "  list                 List all environments with status"
    echo "  start <name>         Start an environment"
    echo "  stop <name>          Stop an environment"
    echo "  delete <name>        Delete an environment and all its data"
    echo "  logs <name>          Show logs for an environment"
    echo "  shell <name>         Open a shell in the WordPress container"
    echo "  wp <name> <cmd>      Run WP-CLI command in the environment"
    echo ""
    echo "Examples:"
    echo "  wpdev new mysite 8085"
    echo "  wpdev list"
    echo "  wpdev stop mysite"
    echo "  wpdev wp mysite plugin list"
}

cmd_new() {
    local name="$1"
    local port="${2:-8080}"

    if [ -z "$name" ]; then
        print_error "Site name is required"
        echo "Usage: wpdev new <name> [port]"
        exit 1
    fi

    # Validate name (alphanumeric and hyphens only)
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        print_error "Site name can only contain letters, numbers, hyphens, and underscores"
        exit 1
    fi

    local site_dir="$SITES_DIR/$name"

    if [ -d "$site_dir" ]; then
        print_error "Site '$name' already exists"
        exit 1
    fi

    # Calculate ports
    local mailpit_ui_port=$((port + 2000))
    local mailpit_smtp_port=$((port + 1000))

    print_info "Creating WordPress environment '$name'..."
    echo "  WordPress: http://localhost:$port"
    echo "  Mailpit:   http://localhost:$mailpit_ui_port"
    echo ""

    # Create site directory and copy template
    mkdir -p "$site_dir"
    cp -r "$TEMPLATE_DIR"/* "$site_dir/"

    # Create html directory for bind mount
    mkdir -p "$site_dir/html"

    # Create .env file with variables
    cat > "$site_dir/.env" << EOF
WPDEV_NAME=$name
PORT=$port
MAILPIT_UI_PORT=$mailpit_ui_port
MAILPIT_SMTP_PORT=$mailpit_smtp_port
HOST_UID=$(id -u)
EOF

    # Build and start
    cd "$site_dir"
    print_info "Building Docker image..."
    docker compose build --quiet

    print_info "Starting containers..."
    docker compose up -d

    print_info "Waiting for WordPress setup to complete..."
    echo "(This may take a minute on first run)"
    echo ""

    # Wait for WordPress to be ready by checking logs
    local max_wait=120
    local waited=0
    while [ $waited -lt $max_wait ]; do
        if docker compose logs wordpress 2>&1 | grep -q "WordPress setup complete!"; then
            break
        fi
        if docker compose logs wordpress 2>&1 | grep -q "WordPress already installed"; then
            break
        fi
        sleep 2
        waited=$((waited + 2))
        echo -n "."
    done
    echo ""

    if [ $waited -ge $max_wait ]; then
        print_warning "Setup is taking longer than expected. Check logs with: wpdev logs $name"
    fi

    echo ""
    print_success "WordPress environment '$name' is ready!"
    echo ""
    echo "========================================"
    echo "  WordPress: http://localhost:$port"
    echo "  Mailpit:   http://localhost:$mailpit_ui_port"
    echo "  Login:     admin / admin"
    echo "========================================"
    echo ""
    echo "Next steps:"
    echo "  1. Open http://localhost:$port/wp-admin"
    echo "  2. Go to Tools > Import"
    echo "  3. Use All-in-One WP Migration to import"
}

cmd_list() {
    echo "WordPress Development Environments"
    echo "==================================="
    echo ""

    if [ ! -d "$SITES_DIR" ] || [ -z "$(ls -A "$SITES_DIR" 2>/dev/null)" ]; then
        echo "No environments found."
        echo "Create one with: wpdev new <name> [port]"
        return
    fi

    printf "%-20s %-10s %-15s %-15s\n" "NAME" "STATUS" "WORDPRESS" "MAILPIT"
    printf "%-20s %-10s %-15s %-15s\n" "----" "------" "---------" "-------"

    for site_dir in "$SITES_DIR"/*/; do
        if [ -d "$site_dir" ]; then
            local name=$(basename "$site_dir")
            local env_file="$site_dir/.env"

            if [ -f "$env_file" ]; then
                source "$env_file"
                local port="${PORT:-8080}"
                local mailpit_port="${MAILPIT_UI_PORT:-$((port + 2000))}"

                # Check if containers are running
                cd "$site_dir"
                local status="stopped"
                if docker compose ps --status running 2>/dev/null | grep -q "${WPDEV_NAME}_wordpress"; then
                    status="running"
                fi

                if [ "$status" = "running" ]; then
                    printf "%-20s ${GREEN}%-10s${NC} %-15s %-15s\n" "$name" "$status" ":$port" ":$mailpit_port"
                else
                    printf "%-20s ${RED}%-10s${NC} %-15s %-15s\n" "$name" "$status" ":$port" ":$mailpit_port"
                fi
            fi
        fi
    done
}

cmd_start() {
    local name="$1"

    if [ -z "$name" ]; then
        print_error "Site name is required"
        exit 1
    fi

    local site_dir="$SITES_DIR/$name"

    if [ ! -d "$site_dir" ]; then
        print_error "Site '$name' does not exist"
        exit 1
    fi

    print_info "Starting '$name'..."
    cd "$site_dir"
    docker compose start

    source "$site_dir/.env"
    print_success "Started! WordPress at http://localhost:$PORT"
}

cmd_stop() {
    local name="$1"

    if [ -z "$name" ]; then
        print_error "Site name is required"
        exit 1
    fi

    local site_dir="$SITES_DIR/$name"

    if [ ! -d "$site_dir" ]; then
        print_error "Site '$name' does not exist"
        exit 1
    fi

    print_info "Stopping '$name'..."
    cd "$site_dir"
    docker compose stop
    print_success "Stopped."
}

cmd_delete() {
    local name="$1"

    if [ -z "$name" ]; then
        print_error "Site name is required"
        exit 1
    fi

    local site_dir="$SITES_DIR/$name"

    if [ ! -d "$site_dir" ]; then
        print_error "Site '$name' does not exist"
        exit 1
    fi

    print_warning "This will delete '$name' and ALL its data (database, uploads, etc.)"
    read -p "Are you sure? (y/N) " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        print_info "Deleting '$name'..."
        cd "$site_dir"
        docker compose down -v --remove-orphans 2>/dev/null || true
        cd "$SITES_DIR"
        rm -rf "$site_dir"
        print_success "Deleted."
    else
        echo "Cancelled."
    fi
}

cmd_logs() {
    local name="$1"

    if [ -z "$name" ]; then
        print_error "Site name is required"
        exit 1
    fi

    local site_dir="$SITES_DIR/$name"

    if [ ! -d "$site_dir" ]; then
        print_error "Site '$name' does not exist"
        exit 1
    fi

    cd "$site_dir"
    docker compose logs -f
}

cmd_shell() {
    local name="$1"

    if [ -z "$name" ]; then
        print_error "Site name is required"
        exit 1
    fi

    local site_dir="$SITES_DIR/$name"

    if [ ! -d "$site_dir" ]; then
        print_error "Site '$name' does not exist"
        exit 1
    fi

    cd "$site_dir"
    docker compose exec wordpress bash
}

cmd_wp() {
    local name="$1"
    shift

    if [ -z "$name" ]; then
        print_error "Site name is required"
        echo "Usage: wpdev wp <name> <wp-cli command>"
        exit 1
    fi

    local site_dir="$SITES_DIR/$name"

    if [ ! -d "$site_dir" ]; then
        print_error "Site '$name' does not exist"
        exit 1
    fi

    cd "$site_dir"
    docker compose exec wordpress wp --allow-root "$@"
}

# Main command handler
case "${1:-}" in
    new)
        shift
        cmd_new "$@"
        ;;
    list|ls)
        cmd_list
        ;;
    start)
        shift
        cmd_start "$@"
        ;;
    stop)
        shift
        cmd_stop "$@"
        ;;
    delete|rm)
        shift
        cmd_delete "$@"
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    shell|sh)
        shift
        cmd_shell "$@"
        ;;
    wp)
        shift
        cmd_wp "$@"
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        usage
        exit 1
        ;;
esac
